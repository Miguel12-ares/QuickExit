{% extends "base.html" %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/administrativo/gestionar_instructores_lideres.css') }}">
{% endblock %}

{% block content %}
<div class="lideres-panel">
  <h2>Gestionar Instructores Líderes</h2>
  <h4>Fichas y sus Instructores Líderes</h4>
  <form id="buscador-lideres" class="mb-3 d-flex flex-wrap" autocomplete="off" style="gap:10px;">
    <input type="text" name="buscar_id" class="form-control" placeholder="ID de ficha" style="width:120px;">
    <input type="text" name="buscar_ficha" class="form-control" placeholder="Nombre de ficha" style="width:180px;">
    <input type="text" name="buscar_instructor" class="form-control" placeholder="Instructor líder" style="width:180px;">
    <select name="buscar_estado" class="form-control" style="width:160px;">
      <option value="">Todos</option>
      <option value="asignado">Con líder asignado</option>
      <option value="sin_asignar">Sin líder</option>
    </select>
    <button type="button" id="btn-buscar-lider" class="btn btn-primary">Buscar</button>
    <button type="button" id="btn-limpiar-lider" class="btn btn-secondary">Limpiar</button>
  </form>
  <div class="table-responsive">
    <table class="lideres-table">
      <thead>
        <tr>
          <th>ID de ficha</th>
          <th>Ficha</th>
          <th>Instructor Líder Actual</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody-lideres">
        {% for ficha in fichas %}
        <tr>
          <td>{{ ficha.id_ficha }}</td>
          <td>{{ ficha.nombre }}</td>
          <td>
            {% if ficha.instructor_lider %}
              <span class="badge-lider">{{ ficha.instructor_lider.nombre }}</span>
            {% else %}
              <span class="badge-sin-lider">Sin instructor líder asignado</span>
            {% endif %}
          </td>
          <td>
            <div style="margin-bottom: 6px;">
              {% if ficha.instructor_lider %}
                <button type="button" class="btn-lider" onclick="document.getElementById('modal-{{ ficha.id_ficha }}').style.display='block'">Cambiar Instructor</button>
                <form action="{{ url_for('main.remover_instructor_lider', id_ficha=ficha.id_ficha) }}" method="POST" style="display:inline-block;">
                  <button type="submit" class="btn-remover">Remover</button>
                </form>
              {% else %}
                <button type="button" class="btn-asignar" onclick="document.getElementById('modal-{{ ficha.id_ficha }}').style.display='block'">Asignar Instructor</button>
              {% endif %}
            </div>
            <!-- Modal de asignación -->
            <div id="modal-{{ ficha.id_ficha }}" class="asignar-modal" style="display:none;">
              <form action="{{ url_for('main.asignar_instructor_lider', id_ficha=ficha.id_ficha) }}" method="POST">
                <div style="font-weight:600;margin-bottom:6px;">Asignar Instructor Líder - {{ ficha.nombre }}</div>
                <select name="id_instructor" required style="width:100%;padding:6px 8px;margin-bottom:10px;border-radius:5px;border:1px solid #bbb;">
                  <option value="">Seleccione un instructor...</option>
                  {% for instructor in instructores %}
                  <option value="{{ instructor.id_usuario }}" {% if ficha.instructor_lider and ficha.instructor_lider.id_usuario == instructor.id_usuario %}selected{% endif %}>{{ instructor.nombre }}</option>
                  {% endfor %}
                </select>
                <div style="display:flex;gap:10px;">
                  <button type="button" class="btn-cancelar" onclick="document.getElementById('modal-{{ ficha.id_ficha }}').style.display='none'">Cancelar</button>
                  <button type="submit" class="btn-asignar">Asignar</button>
                </div>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
  // Cierra todos los modales al hacer clic fuera
  document.addEventListener('click', function(e) {
    document.querySelectorAll('.asignar-modal').forEach(function(modal) {
      if (!modal.contains(e.target) && e.target.type !== 'button') {
        modal.style.display = 'none';
      }
    });
  });
</script>
{% endblock %}

{% block extra_js %}
  <script src="{{ url_for('static', filename='js/administrativo/buscador_ajax/lideres.js') }}"></script>
{% endblock %} 