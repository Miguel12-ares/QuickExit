{% extends "base.html" %}

{% block title %}QuickExit - SENA{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/administrativo/gestionar_instructores_lideres.css') }}">
  <!-- Asegurar que Font Awesome se cargue correctamente -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Meta tags para rutas -->
  <meta name="route-asignar" content="{{ url_for('main.asignar_instructor_lider', id_ficha=0) }}">
  <meta name="route-remover" content="{{ url_for('main.remover_instructor_lider', id_ficha=0) }}">
  <script>
    // Procesar las rutas para reemplazar el ID de ficha con un placeholder
    document.addEventListener('DOMContentLoaded', function() {
      const metaAsignar = document.querySelector('meta[name="route-asignar"]');
      const metaRemover = document.querySelector('meta[name="route-remover"]');
      
      if (metaAsignar) {
        metaAsignar.content = metaAsignar.content.replace('/0', '/');
      }
      
      if (metaRemover) {
        metaRemover.content = metaRemover.content.replace('/0', '/');
      }
    });
  </script>
{% endblock %}

{% block content %}
<div class="lideres-panel">
  <h2><i class="fas fa-users-cog"></i> Gestionar Instructores Líderes</h2>
  
  <form id="buscador-lideres" autocomplete="off">
    <div class="input-group">
      <i class="fas fa-hashtag input-icon"></i>
      <input type="text" name="buscar_id" placeholder="ID de ficha">
    </div>
    <div class="input-group">
      <i class="fas fa-file-alt input-icon"></i>
      <input type="text" name="buscar_ficha" placeholder="Nombre de ficha">
    </div>
    <div class="input-group">
      <i class="fas fa-user-tie input-icon"></i>
      <input type="text" name="buscar_instructor" placeholder="Instructor líder">
    </div>
    <div class="input-group">
      <i class="fas fa-filter input-icon"></i>
      <select name="buscar_estado">
        <option value="">Todos</option>
        <option value="asignado">Con líder asignado</option>
        <option value="sin_asignar">Sin líder</option>
      </select>
    </div>
    
    <div class="botones-busqueda">
      <button type="button" id="btn-buscar-lider" class="btn btn-primary">
        <i class="fas fa-search"></i> Buscar
      </button>
      <button type="button" id="btn-limpiar-lider" class="btn btn-secondary">
        <i class="fas fa-broom"></i> Limpiar
      </button>
    </div>
  </form>

  <div class="table-container">
    <table class="lideres-table">
      <thead>
        <tr>
          <th><i class="fas fa-hashtag"></i> ID de ficha</th>
          <th><i class="fas fa-file-alt"></i> Formación</th>
          <th><i class="fas fa-user-tie"></i> Instructor Líder Actual</th>
          <th><i class="fas fa-cogs"></i> Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody-lideres">
        {% for ficha in fichas %}
        <tr>
          <td>{{ ficha.id_ficha }}</td>
          <td>{{ ficha.nombre }}</td>
          <td>
            {% if ficha.instructor_lider %}
              <span class="badge-lider"><i class="fas fa-check-circle"></i> {{ ficha.instructor_lider.nombre }}</span>
            {% else %}
              <span class="badge-sin-lider"><i class="fas fa-times-circle"></i> Sin instructor líder asignado</span>
            {% endif %}
          </td>
          <td>
            <div class="botones-container">
              {% if ficha.instructor_lider %}
                <button type="button" class="btn-lider" onclick="abrirModal('modal-{{ ficha.id_ficha }}')">
                  <i class="fas fa-exchange-alt"></i> Cambiar Instructor
                </button>
                <form action="{{ url_for('main.remover_instructor_lider', id_ficha=ficha.id_ficha) }}" method="POST" style="display:inline-block;">
                  <button type="submit" class="btn-remover">
                    <i class="fas fa-user-minus"></i> Remover
                  </button>
                </form>
              {% else %}
                <button type="button" class="btn-asignar" onclick="abrirModal('modal-{{ ficha.id_ficha }}')">
                  <i class="fas fa-user-plus"></i> Asignar Instructor
                </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modales de asignación -->
{% for ficha in fichas %}
<div id="modal-{{ ficha.id_ficha }}" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <i class="fas fa-user-plus"></i>
      <h3>Asignar Instructor Líder - {{ ficha.nombre }}</h3>
    </div>
    <form action="{{ url_for('main.asignar_instructor_lider', id_ficha=ficha.id_ficha) }}" method="POST">
      <div class="modal-body">
        <select name="id_instructor" required>
          <option value="">Seleccione un instructor...</option>
          {% for instructor in instructores %}
          <option value="{{ instructor.id_usuario }}" {% if ficha.instructor_lider and ficha.instructor_lider.id_usuario == instructor.id_usuario %}selected{% endif %}>{{ instructor.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn btn-secondary" onclick="cerrarModal('modal-{{ ficha.id_ficha }}')">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="submit" class="modal-btn">
          <i class="fas fa-check"></i> Asignar
        </button>
      </div>
    </form>
  </div>
</div>
{% endfor %}

<script>
  // Cerrar modal al hacer clic en el overlay
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
      e.target.style.display = 'none';
    }
  });
</script>
{% endblock %}

{% block extra_js %}
  <script src="{{ url_for('static', filename='js/administrativo/buscador_ajax/lideres.js') }}"></script>
{% endblock %} 