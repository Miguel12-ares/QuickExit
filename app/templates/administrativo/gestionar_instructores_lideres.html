{% extends "base.html" %}

{% block title %}QuickExit - SENA{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/administrativo/gestionar_instructores_lideres.css') }}">
{% endblock %}

{% block content %}
<div class="lideres-panel">
  <h2><i class="fas fa-users-cog"></i> Gestionar Instructores Líderes</h2>
  <form id="buscador-lideres" class="mb-3 d-flex flex-wrap" autocomplete="off">
    <div class="input-group">
      <i class="fas fa-hashtag input-icon"></i>
      <input type="text" name="buscar_id" class="form-control" placeholder="ID de ficha">
    </div>
    <div class="input-group">
      <i class="fas fa-file-alt input-icon"></i>
      <input type="text" name="buscar_ficha" class="form-control" placeholder="Nombre de ficha">
    </div>
    <div class="input-group">
      <i class="fas fa-user-tie input-icon"></i>
      <input type="text" name="buscar_instructor" class="form-control" placeholder="Instructor líder">
    </div>
    <div class="input-group">
      <i class="fas fa-filter input-icon"></i>
      <select name="buscar_estado" class="form-control">
        <option value="">Todos</option>
        <option value="asignado">Con líder asignado</option>
        <option value="sin_asignar">Sin líder</option>
      </select>
    </div>
    <div class="form-actions">
      <button type="button" id="btn-buscar-lider" class="btn btn-primary"><i class="fas fa-search"></i> Buscar</button>
      <button type="button" id="btn-limpiar-lider" class="btn btn-secondary"><i class="fas fa-broom"></i> Limpiar</button>
    </div>
  </form>
  <div class="table-container">
    <table class="lideres-table">
      <thead>
        <tr>
          <th><i class="fas fa-hashtag"></i> ID de ficha</th>
          <th><i class="fas fa-file-alt"></i> Formación</th>
          <th><i class="fas fa-user-tie"></i> Instructor Líder Actual</th>
          <th><i class="fas fa-cogs"></i> Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody-lideres">
        {% for ficha in fichas %}
        <tr>
          <td>{{ ficha.id_ficha }}</td>
          <td>{{ ficha.nombre }}</td>
          <td>
            {% if ficha.instructor_lider %}
              <span class="badge-lider"><i class="fas fa-check-circle"></i> {{ ficha.instructor_lider.nombre }}</span>
            {% else %}
              <span class="badge-sin-lider"><i class="fas fa-times-circle"></i> Sin instructor líder asignado</span>
            {% endif %}
          </td>
          <td>
            <div style="margin-bottom: 6px;">
              {% if ficha.instructor_lider %}
                <button type="button" class="btn-lider" onclick="document.getElementById('modal-{{ ficha.id_ficha }}').style.display='block'">
                  <i class="fas fa-exchange-alt"></i> Cambiar Instructor
                </button>
                <form action="{{ url_for('main.remover_instructor_lider', id_ficha=ficha.id_ficha) }}" method="POST" style="display:inline-block;">
                  <button type="submit" class="btn-remover">
                    <i class="fas fa-user-minus"></i> Remover
                  </button>
                </form>
              {% else %}
                <button type="button" class="btn-asignar" onclick="document.getElementById('modal-{{ ficha.id_ficha }}').style.display='block'">
                  <i class="fas fa-user-plus"></i> Asignar Instructor
                </button>
              {% endif %}
            </div>
            <!-- Modal de asignación -->
            <div id="modal-{{ ficha.id_ficha }}" class="asignar-modal" style="display:none;">
              <form action="{{ url_for('main.asignar_instructor_lider', id_ficha=ficha.id_ficha) }}" method="POST">
                <div style="font-weight:600;margin-bottom:6px;">
                  <i class="fas fa-user-plus"></i> Asignar Instructor Líder - {{ ficha.nombre }}
                </div>
                <select name="id_instructor" required class="form-control">
                  <option value="">Seleccione un instructor...</option>
                  {% for instructor in instructores %}
                  <option value="{{ instructor.id_usuario }}" {% if ficha.instructor_lider and ficha.instructor_lider.id_usuario == instructor.id_usuario %}selected{% endif %}>{{ instructor.nombre }}</option>
                  {% endfor %}
                </select>
                <div class="form-actions" style="margin-top: 1rem;">
                  <button type="button" class="btn-cancelar" onclick="document.getElementById('modal-{{ ficha.id_ficha }}').style.display='none'">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                  <button type="submit" class="btn-asignar">
                    <i class="fas fa-check"></i> Asignar
                  </button>
                </div>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
  // Cierra todos los modales al hacer clic fuera
  document.addEventListener('click', function(e) {
    document.querySelectorAll('.asignar-modal').forEach(function(modal) {
      if (!modal.contains(e.target) && e.target.type !== 'button') {
        modal.style.display = 'none';
      }
    });
  });
</script>
{% endblock %}

{% block extra_js %}
  <script src="{{ url_for('static', filename='js/administrativo/buscador_ajax/lideres.js') }}"></script>
{% endblock %} 